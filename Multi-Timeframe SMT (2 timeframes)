//@version=6
// -----------------------------------------------------------------------------
// Title:         Standalone SMT (Dual-Timeframe, Stripped)
// Author:        Nick
// Version:       9.1.0 (Stripped + Offset)
// Description: - Reverted the Early Detection (LTF) logic to the more robust per-bar
//                fallback system to fix an issue where unconfirmed SMTs would not print.
//              - Stripped code down to two independent SMT timeframe engines.
//              - Added hardcoded ATR offset to 'x' pivot markers.
// -----------------------------------------------------------------------------

import TradingView/ta/6 as ta

indicator('Standalone SMT (Dual, Stripped)', 'SMT', overlay = true, max_labels_count=500, max_lines_count=500)

// =============================================================================
// INPUTS
// =============================================================================
string GRP_TIME_FILTER = "Time Session Filter"
sessionTimezone = input.string("America/New_York", "Session Timezone", group = GRP_TIME_FILTER, tooltip = "Specify the timezone for the session filters. Examples: 'America/New_York', 'Europe/London', 'Etc/UTC'.")
enableTimeFilter1 = input.bool(false, "Enable Session Filter 1", group = GRP_TIME_FILTER, tooltip="If checked, the indicator will only plot SMT signals within this specified trading session.")
timeSession1 = input.session("0800-1200", "Trading Session 1", group = GRP_TIME_FILTER, tooltip="Define the time window for plotting SMTs. Format is HHMM-HHMM.")
enableTimeFilter2 = input.bool(false, "Enable Session Filter 2", group = GRP_TIME_FILTER, tooltip="If checked, the indicator will only plot SMT signals within this specified trading session.")
timeSession2 = input.session("1300-1700", "Trading Session 2", group = GRP_TIME_FILTER, tooltip="Define the time window for plotting SMTs. Format is HHMM-HHMM.")
enableTimeFilter3 = input.bool(false, "Enable Session Filter 3", group = GRP_TIME_FILTER, tooltip="If checked, the indicator will only plot SMT signals within this specified trading session.")
timeSession3 = input.session("0000-0700", "Trading Session 3", group = GRP_TIME_FILTER, tooltip="Define the time window for plotting SMTs. Format is HHMM-HHMM.")


string GRP_MASTER_ASSET = "Comparison Asset"
masterComparisonAsset = input.symbol("CME_MINI_DL:NQ1!", "Asset", group = GRP_MASTER_ASSET, tooltip = "Select the second asset to compare against the main chart's asset for detecting SMT.")

// --- SMT Timeframe 1 ---
string GRP_SMT1 = "SMT Settings (Timeframe 1)"
enableSMT1 = input.bool(true, "Enable Timeframe 1", group = GRP_SMT1, tooltip = "Master switch to turn the entire SMT detection logic on or off for the first timeframe.")
showPivotALabel_SMT1 = input.bool(true, "Show Pivot 'A' Label", group = GRP_SMT1, tooltip = "Toggles the 'A' label on the first pivot of a potential SMT setup for this timeframe.")
showPivotCrosses_SMT1 = input.bool(true, 'Show Pivots', group = GRP_SMT1, tooltip = "Toggles the visibility of the '+' markers on all identified Higher Timeframe pivots.")
enableEarlySmtDetection_SMT1 = input.bool(true, "Enable LTF Detection", group = GRP_SMT1, tooltip = "Enables the logic to look for SMT divergences on a lower timeframe (LTF), providing early, unconfirmed signals before the higher timeframe (HTF) bar closes.")
enableAlerts_SMT1 = input.bool(true, "Enable Alerts", group = GRP_SMT1, tooltip = "Enables alerts for both unconfirmed (LTF) and confirmed (HTF) SMT signals.")

string GRP_TIMEFRAMES_STRENGTH1 = "Timeframe & Strength Settings (Timeframe 1)"
timeframeInput_SMT1 = input.timeframe('240', 'Timeframe', group = GRP_TIMEFRAMES_STRENGTH1, tooltip = "Sets the higher timeframe (HTF) on which the main pivots are identified and SMTs are confirmed.")
leftBars_SMT1 = input.int(1, 'Left Strength', group = GRP_TIMEFRAMES_STRENGTH1, minval = 1, tooltip = "Defines the strength of a pivot. This is the number of bars to the left of a pivot candle that must have lower highs (for a pivot high) or higher lows (for a pivot low).")
rightBars_SMT1 = input.int(1, 'Right Strength', group = GRP_TIMEFRAMES_STRENGTH1, minval = 1, tooltip = "Defines the strength of a pivot. This is the number of bars to the right of a pivot candle that must have lower highs (for a pivot high) or higher lows (for a pivot low).")
intradayTimeframe_SMT1 = input.timeframe('15', "LTF Detection", group = GRP_TIMEFRAMES_STRENGTH1, tooltip = "Sets the lower timeframe (LTF) used for Early SMT Detection. The unconfirmed signals will only appear when your chart's timeframe is equal to or lower than this setting.")

string GRP_CROSSES_SMT1 = "Pivot Cross Colors (Timeframe 1)"
phColor_SMT1 = input.color(color.red, "High Color", group = GRP_CROSSES_SMT1, tooltip = "Sets the color for bearish elements: high pivots, bearish SMT lines, and labels.")
plColor_SMT1 = input.color(color.green, "Low Color", group = GRP_CROSSES_SMT1, tooltip = "Sets the color for bullish elements: low pivots, bullish SMT lines, and labels.")

// --- SMT Timeframe 2 ---
string GRP_SMT2 = "SMT Settings (Timeframe 2)"
enableSMT2 = input.bool(false, "Enable Timeframe 2", group = GRP_SMT2, tooltip = "Master switch to turn the entire SMT detection logic on or off for the second timeframe.")
showPivotALabel_SMT2 = input.bool(true, "Show Pivot 'A' Label", group = GRP_SMT2, tooltip = "Toggles the 'A' label on the first pivot of a potential SMT setup for this timeframe.")
showPivotCrosses_SMT2 = input.bool(true, 'Show Pivots', group = GRP_SMT2, tooltip = "Toggles the visibility of the '+' markers on all identified Higher Timeframe pivots.")
enableEarlySmtDetection_SMT2 = input.bool(true, "Enable LTF Detection", group = GRP_SMT2, tooltip = "Enables the logic to look for SMT divergences on a lower timeframe (LTF), providing early, unconfirmed signals before the higher timeframe (HTF) bar closes.")
enableAlerts_SMT2 = input.bool(true, "Enable Alerts", group = GRP_SMT2, tooltip = "Enables alerts for both unconfirmed (LTF) and confirmed (HTF) SMT signals.")

string GRP_TIMEFRAMES_STRENGTH2 = "Timeframe & Strength Settings (Timeframe 2)"
timeframeInput_SMT2 = input.timeframe('60', 'Timeframe', group = GRP_TIMEFRAMES_STRENGTH2, tooltip = "Sets the higher timeframe (HTF) on which the main pivots are identified and SMTs are confirmed.")
leftBars_SMT2 = input.int(1, 'Left Strength', group = GRP_TIMEFRAMES_STRENGTH2, minval = 1, tooltip = "Defines the strength of a pivot. This is the number of bars to the left of a pivot candle that must have lower highs (for a pivot high) or higher lows (for a pivot low).")
rightBars_SMT2 = input.int(1, 'Right Strength', group = GRP_TIMEFRAMES_STRENGTH2, minval = 1, tooltip = "Defines the strength of a pivot. This is the number of bars to the right of a pivot candle that must have lower highs (for a pivot high) or higher lows (for a pivot low).")
intradayTimeframe_SMT2 = input.timeframe('5', "LTF Detection", group = GRP_TIMEFRAMES_STRENGTH2, tooltip = "Sets the lower timeframe (LTF) used for Early SMT Detection. The unconfirmed signals will only appear when your chart's timeframe is equal to or lower than this setting.")

string GRP_CROSSES_SMT2 = "Pivot Cross Colors (Timeframe 2)"
phColor_SMT2 = input.color(color.new(color.orange, 0), "High Color", group = GRP_CROSSES_SMT2, tooltip = "Sets the color for bearish elements: high pivots, bearish SMT lines, and labels.")
plColor_SMT2 = input.color(color.new(color.blue, 0), "Low Color", group = GRP_CROSSES_SMT2, tooltip = "Sets the color for bullish elements: low pivots, bullish SMT lines, and labels.")

// =============================================================================
// CONSTANTS & FUNCTIONS
// =============================================================================
int MAX_DRAWING_OBJECTS = 500
int MAX_HISTORY_SIZE = 500
// MODIFICATION: Hardcoded the offset percentage (0.1 = 10% of ATR) for 'x' markers
float PIVOT_CROSS_OFFSET_PERCENT = 0.1

isWithinAnySession() =>
    anyFilterEnabled = enableTimeFilter1 or enableTimeFilter2 or enableTimeFilter3
    if not anyFilterEnabled
        true
    else
        inSession1 = enableTimeFilter1 and not na(time(timeframe.period, timeSession1, sessionTimezone))
        inSession2 = enableTimeFilter2 and not na(time(timeframe.period, timeSession2, sessionTimezone))
        inSession3 = enableTimeFilter3 and not na(time(timeframe.period, timeSession3, sessionTimezone))
        inSession1 or inSession2 or inSession3

getTicker(string symbolString) =>
    str.contains(symbolString, ":") ? str.substring(symbolString, str.pos(symbolString, ":") + 1, str.length(symbolString)) : symbolString

formatTimeframe(string tf) =>
    var result = tf
    float tf_minutes = str.tonumber(tf)
    if not na(tf_minutes)
        if tf_minutes >= 60 and tf_minutes % 60 == 0
            result := str.tostring(int(tf_minutes / 60)) + 'H'
        else
            result := str.tostring(int(tf_minutes)) + 'M'
    result

checkForPivot(array<float> history, int pivot_idx, int left_strength, int right_strength, bool is_high) =>
    is_pivot = true
    if array.size(history) < left_strength + right_strength + 1 or pivot_idx < left_strength or pivot_idx > array.size(history) - 1 - right_strength
        is_pivot := false
    else
        pivot_price = array.get(history, pivot_idx)
        for i = 0 to left_strength + right_strength
            if i != left_strength
                neighbor_price = array.get(history, pivot_idx - left_strength + i)
                if is_high and neighbor_price >= pivot_price
                    is_pivot := false
                    break
                if not is_high and neighbor_price <= pivot_price
                    is_pivot := false
                    break
    is_pivot

drawPivotCross(array<label> labelsArray, int bar_time, float price, color p_color) =>
    label newLabel = label.new(bar_time, price, xloc=xloc.bar_time, style=label.style_xcross, color=p_color, size=size.tiny)
    array.push(labelsArray, newLabel)
    if array.size(labelsArray) > MAX_DRAWING_OBJECTS
        label.delete(array.shift(labelsArray))

// =============================================================================
// GLOBAL CALCULATIONS
// =============================================================================
// MODIFICATION: Calculate the price offset for 'x' markers globally
float globalAtr = nz(ta.atr(14))
float priceOffset = globalAtr * PIVOT_CROSS_OFFSET_PERCENT

// =============================================================================
// SMT 1: LOGIC CHECKS
// =============================================================================
bool isHistoryCollectionActive_SMT1 = enableSMT1 and timeframeInput_SMT1 != ''
bool is_new_htf_bar_SMT1 = isHistoryCollectionActive_SMT1 and (nz(ta.change(time(timeframeInput_SMT1))) != 0)
bool isHtfChartTimeframeValid_SMT1 = timeframe.in_seconds(timeframe.period) <= timeframe.in_seconds(timeframeInput_SMT1)
bool isSmtLogicActive_SMT1 = isHtfChartTimeframeValid_SMT1 and isHistoryCollectionActive_SMT1 and enableSMT1 and masterComparisonAsset != ""

// =============================================================================
// SMT 1: HISTORY COLLECTION BLOCKS
// =============================================================================
var label[] smT1_PivotLabels = array.new_label()
var float smt1_session_high = high, var float smt1_session_low = low
var int smt1_session_high_time = time, var int smt1_session_low_time = time
var array<float> smt1_history_highs = array.new_float(), var array<float> smt1_history_lows = array.new_float()
var array<int> smt1_history_times_high = array.new_int(), var array<int> smt1_history_times_low = array.new_int()
var array<float> smt1_comp_history_highs = array.new_float(), var array<float> smt1_comp_history_lows = array.new_float()

if isHistoryCollectionActive_SMT1
    if is_new_htf_bar_SMT1
        smt1_session_high := high, smt1_session_low := low
        smt1_session_high_time := time, smt1_session_low_time := time
    else
        if high >= smt1_session_high
            smt1_session_high := high, smt1_session_high_time := time
        if low <= smt1_session_low
            smt1_session_low := low, smt1_session_low_time := time
    if is_new_htf_bar_SMT1
        array.push(smt1_history_highs, smt1_session_high[1]), array.push(smt1_history_times_high, smt1_session_high_time[1])
        array.push(smt1_history_lows, smt1_session_low[1]), array.push(smt1_history_times_low, smt1_session_low_time[1])
        float comp_high = request.security(masterComparisonAsset, timeframeInput_SMT1, high[1], lookahead=barmerge.lookahead_on)
        float comp_low = request.security(masterComparisonAsset, timeframeInput_SMT1, low[1], lookahead=barmerge.lookahead_on)
        array.push(smt1_comp_history_highs, comp_high), array.push(smt1_comp_history_lows, comp_low)

        if array.size(smt1_history_highs) > MAX_HISTORY_SIZE
            array.shift(smt1_history_highs)
            array.shift(smt1_history_times_high)
            array.shift(smt1_history_lows)
            array.shift(smt1_history_times_low)
            array.shift(smt1_comp_history_highs)
            array.shift(smt1_comp_history_lows)

        if showPivotCrosses_SMT1
            int pivot_check_index = array.size(smt1_history_highs) - 1 - rightBars_SMT1
            if pivot_check_index >= 0
                // MODIFICATION: Apply offset before drawing
                if checkForPivot(smt1_history_highs, pivot_check_index, leftBars_SMT1, rightBars_SMT1, true)
                    float pivot_price = array.get(smt1_history_highs, pivot_check_index)
                    float plot_price = pivot_price + priceOffset
                    drawPivotCross(smT1_PivotLabels, array.get(smt1_history_times_high, pivot_check_index), plot_price, phColor_SMT1)
                // MODIFICATION: Apply offset before drawing
                if checkForPivot(smt1_history_lows, pivot_check_index, leftBars_SMT1, rightBars_SMT1, false)
                    float pivot_price = array.get(smt1_history_lows, pivot_check_index)
                    float plot_price = pivot_price - priceOffset
                    drawPivotCross(smT1_PivotLabels, array.get(smt1_history_times_low, pivot_check_index), plot_price, plColor_SMT1)

// =============================================================================
// SMT 1: LOGIC
// =============================================================================
var label pivotA_HighLabel_SMT1 = na, var label visualPivotA_HighLabel_SMT1 = na, var label pivotA_LowLabel_SMT1 = na, var label visualPivotA_LowLabel_SMT1 = na, var line intraDayHighWatchline_SMT1 = na, var line intraDayLowWatchline_SMT1 = na, var label intraDayHighLabel_SMT1 = na, var label intraDayLowLabel_SMT1 = na, var float intraDayWatchlineHighPrice_SMT1 = na, var float intraDayWatchlineLowPrice_SMT1 = na, var bool ltfMainAssetInvalidatedHigh_SMT1 = false, var bool ltfCompAssetInvalidatedHigh_SMT1 = false, var bool ltfMainAssetInvalidatedLow_SMT1 = false, var bool ltfCompAssetInvalidatedLow_SMT1 = false
var array<line> smtConfirmedLines_SMT1 = array.new_line(), var array<label> smtConfirmedLabels_SMT1 = array.new_label()

cleanupSmtDrawings1() =>
    for l in smtConfirmedLines_SMT1
        line.delete(l)
    array.clear(smtConfirmedLines_SMT1)
    for l in smtConfirmedLabels_SMT1
        label.delete(l)
    array.clear(smtConfirmedLabels_SMT1)
    label.delete(pivotA_HighLabel_SMT1), label.delete(visualPivotA_HighLabel_SMT1)
    label.delete(pivotA_LowLabel_SMT1), label.delete(visualPivotA_LowLabel_SMT1)
    line.delete(intraDayHighWatchline_SMT1), label.delete(intraDayHighLabel_SMT1)
    line.delete(intraDayLowWatchline_SMT1), label.delete(intraDayLowLabel_SMT1)

if isSmtLogicActive_SMT1
    bool isWithinTimeSession = isWithinAnySession()
    string shortAssetName = getTicker(masterComparisonAsset)
    float atr_SMT1 = ta.atr(14) // This ATR is for the SMT labels, not the 'x' crosses
    float y_offset_SMT1 = atr_SMT1 * 0.1
    if is_new_htf_bar_SMT1
        int pivot_idx = array.size(smt1_history_highs) - 1 - rightBars_SMT1
        if pivot_idx >= 0
            bool is_main_pivot_high = checkForPivot(smt1_history_highs, pivot_idx, leftBars_SMT1, rightBars_SMT1, true)
            bool is_comp_pivot_high = checkForPivot(smt1_comp_history_highs, pivot_idx, leftBars_SMT1, rightBars_SMT1, true)
            if is_main_pivot_high and is_comp_pivot_high
                float mainHtfPivotHigh = array.get(smt1_history_highs, pivot_idx)
                float compHtfPivotHigh = array.get(smt1_comp_history_highs, pivot_idx)
                int smt_main_pivot_time = array.get(smt1_history_times_high, pivot_idx)
                if not na(pivotA_HighLabel_SMT1)
                    if (mainHtfPivotHigh - label.get_y(pivotA_HighLabel_SMT1)) * (compHtfPivotHigh - str.tonumber(label.get_text(pivotA_HighLabel_SMT1))) < 0
                        bool wasPivotARun = false
                        for i = pivot_idx - 1 to 0
                            if array.get(smt1_history_times_high, i) > label.get_x(pivotA_HighLabel_SMT1)
                                if array.get(smt1_history_highs, i) > label.get_y(pivotA_HighLabel_SMT1)
                                    wasPivotARun := true, break
                            else
                                break
                        if not wasPivotARun and isWithinTimeSession
                            string confirmedTextTemplate = "{0} vs {1}\nTimeframe: {2}\nStrength: {3}-{4}"
                            string baseInfoText = str.format(confirmedTextTemplate, syminfo.ticker, shortAssetName, formatTimeframe(timeframeInput_SMT1), str.tostring(leftBars_SMT1), str.tostring(rightBars_SMT1))
                            line newLine = line.new(label.get_x(pivotA_HighLabel_SMT1), label.get_y(pivotA_HighLabel_SMT1), smt_main_pivot_time, mainHtfPivotHigh, xloc = xloc.bar_time, color=color.new(phColor_SMT1, 40), width=2)
                            label newLabel = label.new(smt_main_pivot_time, mainHtfPivotHigh + y_offset_SMT1, "SMT Bearish\n" + baseInfoText + "\nStatus: Confirmed", xloc = xloc.bar_time, color=color.new(phColor_SMT1, 75), textcolor=color.white, style=label.style_label_down, size=size.normal, textalign=text.align_left)
                            array.push(smtConfirmedLines_SMT1, newLine), array.push(smtConfirmedLabels_SMT1, newLabel)
                            if enableAlerts_SMT1
                                alert("Confirmed Bearish SMT on SMT TF1", alert.freq_once_per_bar)
                line.delete(intraDayHighWatchline_SMT1), intraDayHighWatchline_SMT1 := na, label.delete(intraDayHighLabel_SMT1), intraDayHighLabel_SMT1 := na, intraDayWatchlineHighPrice_SMT1 := na
                label.delete(pivotA_HighLabel_SMT1), label.delete(visualPivotA_HighLabel_SMT1)
                pivotA_HighLabel_SMT1 := label.new(smt_main_pivot_time, mainHtfPivotHigh, str.tostring(compHtfPivotHigh), xloc = xloc.bar_time, style=label.style_none, textcolor=color.new(color.white, 100))
                visualPivotA_HighLabel_SMT1 := label.new(smt_main_pivot_time, mainHtfPivotHigh + y_offset_SMT1, "A", xloc=xloc.bar_time, style=label.style_label_down, color=color.new(phColor_SMT1, 25), textcolor=color.white, size=size.small, tooltip="Pivot A High")
                ltfMainAssetInvalidatedHigh_SMT1 := false, ltfCompAssetInvalidatedHigh_SMT1 := false
            bool is_main_pivot_low = checkForPivot(smt1_history_lows, pivot_idx, leftBars_SMT1, rightBars_SMT1, false)
            bool is_comp_pivot_low = checkForPivot(smt1_comp_history_lows, pivot_idx, leftBars_SMT1, rightBars_SMT1, false)
            if is_main_pivot_low and is_comp_pivot_low
                float mainHtfPivotLow = array.get(smt1_history_lows, pivot_idx)
                float compHtfPivotLow = array.get(smt1_comp_history_lows, pivot_idx)
                int smt_main_pivot_time = array.get(smt1_history_times_low, pivot_idx)
                if not na(pivotA_LowLabel_SMT1)
                    if (mainHtfPivotLow - label.get_y(pivotA_LowLabel_SMT1)) * (compHtfPivotLow - str.tonumber(label.get_text(pivotA_LowLabel_SMT1))) < 0
                        bool wasPivotARun = false
                        for i = pivot_idx - 1 to 0
                            if array.get(smt1_history_times_low, i) > label.get_x(pivotA_LowLabel_SMT1)
                                if array.get(smt1_history_lows, i) < label.get_y(pivotA_LowLabel_SMT1)
                                    wasPivotARun := true, break
                            else
                                break
                        if not wasPivotARun and isWithinTimeSession
                            string confirmedTextTemplate = "{0} vs {1}\nTimeframe: {2}\nStrength: {3}-{4}"
                            string baseInfoText = str.format(confirmedTextTemplate, syminfo.ticker, shortAssetName, formatTimeframe(timeframeInput_SMT1), str.tostring(leftBars_SMT1), str.tostring(rightBars_SMT1))
                            line newLine = line.new(label.get_x(pivotA_LowLabel_SMT1), label.get_y(pivotA_LowLabel_SMT1), smt_main_pivot_time, mainHtfPivotLow, xloc = xloc.bar_time, color=color.new(plColor_SMT1, 40), width=2)
                            label newLabel = label.new(smt_main_pivot_time, mainHtfPivotLow - y_offset_SMT1, "SMT Bullish\n" + baseInfoText + "\nStatus: Confirmed", xloc = xloc.bar_time, color=color.new(plColor_SMT1, 75), textcolor=color.white, style=label.style_label_up, size=size.normal, textalign=text.align_left)
                            array.push(smtConfirmedLines_SMT1, newLine), array.push(smtConfirmedLabels_SMT1, newLabel)
                            if enableAlerts_SMT1
                                alert("Confirmed Bullish SMT on SMT TF1", alert.freq_once_per_bar)
                line.delete(intraDayLowWatchline_SMT1), intraDayLowWatchline_SMT1 := na, label.delete(intraDayLowLabel_SMT1), intraDayLowLabel_SMT1 := na, intraDayWatchlineLowPrice_SMT1 := na
                label.delete(pivotA_LowLabel_SMT1), label.delete(visualPivotA_LowLabel_SMT1)
                pivotA_LowLabel_SMT1 := label.new(smt_main_pivot_time, mainHtfPivotLow, str.tostring(compHtfPivotLow), xloc = xloc.bar_time, style=label.style_none, textcolor=color.new(color.white, 100))
                visualPivotA_LowLabel_SMT1 := label.new(smt_main_pivot_time, mainHtfPivotLow - y_offset_SMT1, "A", xloc=xloc.bar_time, style=label.style_label_up, color=color.new(plColor_SMT1, 25), textcolor=color.white, size=size.small, tooltip="Pivot A Low")
                ltfMainAssetInvalidatedLow_SMT1 := false, ltfCompAssetInvalidatedLow_SMT1 := false
    
    // =================================== START: CORRECTED SMT1 LTF LOGIC ===================================
    if enableEarlySmtDetection_SMT1 and intradayTimeframe_SMT1 != '' and timeframe.in_seconds(timeframe.period) <= timeframe.in_seconds(intradayTimeframe_SMT1)
        bool is_new_intraday_bar = ta.change(time(intradayTimeframe_SMT1)) != 0
        var float intraday_session_high_SMT1 = high, var float intraday_session_low_SMT1 = low, var int intraday_session_high_time_SMT1 = time, var int intraday_session_low_time_SMT1 = time
        
        // --- Reverted Per-Bar Fallback System (More Robust) ---
        var string usedLtfTimeframe_SMT1 = intradayTimeframe_SMT1
        [intra_comp_high_realtime_SMT1_base, intra_comp_low_realtime_SMT1_base] = request.security(masterComparisonAsset, intradayTimeframe_SMT1, [high, low], lookahead=barmerge.lookahead_off)
        usedLtfTimeframe_SMT1 := intradayTimeframe_SMT1
        
        float intra_comp_high_realtime_SMT1 = intra_comp_high_realtime_SMT1_base
        float intra_comp_low_realtime_SMT1 = intra_comp_low_realtime_SMT1_base

        if na(intra_comp_high_realtime_SMT1)
            [intra_comp_high_realtime_SMT1, intra_comp_low_realtime_SMT1] = request.security(masterComparisonAsset, '15', [high, low], lookahead=barmerge.lookahead_off)
            usedLtfTimeframe_SMT1 := '15'
        if na(intra_comp_high_realtime_SMT1)
            [intra_comp_high_realtime_SMT1, intra_comp_low_realtime_SMT1] = request.security(masterComparisonAsset, '60', [high, low], lookahead=barmerge.lookahead_off)
            usedLtfTimeframe_SMT1 := '60'

        var float intraday_comp_session_high_SMT1 = intra_comp_high_realtime_SMT1, var float intraday_comp_session_low_SMT1 = intra_comp_low_realtime_SMT1
        if is_new_intraday_bar
            intraday_session_high_SMT1 := high, intraday_session_low_SMT1 := low, intraday_session_high_time_SMT1 := time, intraday_session_low_time_SMT1 := time
            intraday_comp_session_high_SMT1 := intra_comp_high_realtime_SMT1, intraday_comp_session_low_SMT1 := intra_comp_low_realtime_SMT1
        else
            if high > intraday_session_high_SMT1
                intraday_session_high_SMT1 := high, intraday_session_high_time_SMT1 := time
            if low < intraday_session_low_SMT1
                intraday_session_low_SMT1 := low, intraday_session_low_time_SMT1 := time
            if intra_comp_high_realtime_SMT1 > intraday_comp_session_high_SMT1
                intraday_comp_session_high_SMT1 := intra_comp_high_realtime_SMT1
            if intra_comp_low_realtime_SMT1 < intraday_comp_session_low_SMT1
                intraday_comp_session_low_SMT1 := intra_comp_low_realtime_SMT1
        if is_new_intraday_bar
            float ltf_main_high = intraday_session_high_SMT1[1], float ltf_main_low = intraday_session_low_SMT1[1]
            float intra_comp_high = intraday_comp_session_high_SMT1[1], float intra_comp_low = intraday_comp_session_low_SMT1[1]
            if not na(pivotA_HighLabel_SMT1)
                if not ltfMainAssetInvalidatedHigh_SMT1 and ltf_main_high > label.get_y(pivotA_HighLabel_SMT1)
                    ltfMainAssetInvalidatedHigh_SMT1 := true
                if not ltfCompAssetInvalidatedHigh_SMT1 and intra_comp_high > str.tonumber(label.get_text(pivotA_HighLabel_SMT1))
                    ltfCompAssetInvalidatedHigh_SMT1 := true
                if ltfMainAssetInvalidatedHigh_SMT1 and ltfCompAssetInvalidatedHigh_SMT1
                    label.delete(pivotA_HighLabel_SMT1), pivotA_HighLabel_SMT1 := na, label.delete(visualPivotA_HighLabel_SMT1), visualPivotA_HighLabel_SMT1 := na
                    line.delete(intraDayHighWatchline_SMT1), intraDayHighWatchline_SMT1 := na, label.delete(intraDayHighLabel_SMT1), intraDayHighLabel_SMT1 := na
            if not na(pivotA_LowLabel_SMT1)
                if not ltfMainAssetInvalidatedLow_SMT1 and ltf_main_low < label.get_y(pivotA_LowLabel_SMT1)
                    ltfMainAssetInvalidatedLow_SMT1 := true
                if not ltfCompAssetInvalidatedLow_SMT1 and intra_comp_low < str.tonumber(label.get_text(pivotA_LowLabel_SMT1))
                    ltfCompAssetInvalidatedLow_SMT1 := true
                if ltfMainAssetInvalidatedLow_SMT1 and ltfCompAssetInvalidatedLow_SMT1
                    label.delete(pivotA_LowLabel_SMT1), pivotA_LowLabel_SMT1 := na, label.delete(visualPivotA_LowLabel_SMT1), visualPivotA_LowLabel_SMT1 := na
                    line.delete(intraDayLowWatchline_SMT1), intraDayLowWatchline_SMT1 := na, label.delete(intraDayLowLabel_SMT1), intraDayLowLabel_SMT1 := na
            int ltf_main_high_time = intraday_session_high_time_SMT1[1], int ltf_main_low_time = intraday_session_low_time_SMT1[1]
            if not na(pivotA_HighLabel_SMT1)
                bool alreadyInvalidated = ltfMainAssetInvalidatedHigh_SMT1 and ltfCompAssetInvalidatedHigh_SMT1
                if not alreadyInvalidated and (ltf_main_high - label.get_y(pivotA_HighLabel_SMT1)) * (intra_comp_high - str.tonumber(label.get_text(pivotA_HighLabel_SMT1))) < 0 and (na(intraDayWatchlineHighPrice_SMT1) or ltf_main_high > intraDayWatchlineHighPrice_SMT1) and isWithinTimeSession
                    string ltfBaseTextTemplate = "{0} vs {1}\nTimeframe: {2}\nStrength: {3}-{4}\nLTF Detection: {5}"
                    string ltfBaseInfoText = str.format(ltfBaseTextTemplate, syminfo.ticker, shortAssetName, formatTimeframe(timeframeInput_SMT1), str.tostring(leftBars_SMT1), str.tostring(rightBars_SMT1), formatTimeframe(usedLtfTimeframe_SMT1))
                    line.delete(intraDayHighWatchline_SMT1), label.delete(intraDayHighLabel_SMT1)
                    intraDayHighWatchline_SMT1 := line.new(label.get_x(pivotA_HighLabel_SMT1), label.get_y(pivotA_HighLabel_SMT1), ltf_main_high_time, ltf_main_high, xloc = xloc.bar_time, style=line.style_dashed, color=phColor_SMT1, width=1)
                    intraDayHighLabel_SMT1 := label.new(ltf_main_high_time, ltf_main_high + y_offset_SMT1, "SMT Bearish\n" + ltfBaseInfoText + "\nStatus: Unconfirmed", xloc = xloc.bar_time, color=color.new(phColor_SMT1, 75), textcolor=color.white, style=label.style_label_down, textalign=text.align_left)
                    intraDayWatchlineHighPrice_SMT1 := ltf_main_high, ltfMainAssetInvalidatedHigh_SMT1 := false, ltfCompAssetInvalidatedHigh_SMT1 := false
                    if enableAlerts_SMT1
                        alert("Potential Bearish SMT on SMT TF 1", alert.freq_once_per_bar)
            if not na(pivotA_LowLabel_SMT1)
                bool alreadyInvalidated = ltfMainAssetInvalidatedLow_SMT1 and ltfCompAssetInvalidatedLow_SMT1
                if not alreadyInvalidated and (ltf_main_low - label.get_y(pivotA_LowLabel_SMT1)) * (intra_comp_low - str.tonumber(label.get_text(pivotA_LowLabel_SMT1))) < 0 and (na(intraDayWatchlineLowPrice_SMT1) or ltf_main_low < intraDayWatchlineLowPrice_SMT1) and isWithinTimeSession
                    string ltfBaseTextTemplate = "{0} vs {1}\nTimeframe: {2}\nStrength: {3}-{4}\nLTF Detection: {5}"
                    string ltfBaseInfoText = str.format(ltfBaseTextTemplate, syminfo.ticker, shortAssetName, formatTimeframe(timeframeInput_SMT1), str.tostring(leftBars_SMT1), str.tostring(rightBars_SMT1), formatTimeframe(usedLtfTimeframe_SMT1))
                    line.delete(intraDayLowWatchline_SMT1), label.delete(intraDayLowLabel_SMT1)
                    intraDayLowWatchline_SMT1 := line.new(label.get_x(pivotA_LowLabel_SMT1), label.get_y(pivotA_LowLabel_SMT1), ltf_main_low_time, ltf_main_low, xloc = xloc.bar_time, style=line.style_dashed, color=plColor_SMT1, width=1)
                    intraDayLowLabel_SMT1 := label.new(ltf_main_low_time, ltf_main_low - y_offset_SMT1, "SMT Bullish\n" + ltfBaseInfoText + "\nStatus: Unconfirmed", xloc = xloc.bar_time, color=color.new(plColor_SMT1, 75), textcolor=color.white, style=label.style_label_up, textalign=text.align_left)
                    intraDayWatchlineLowPrice_SMT1 := ltf_main_low, ltfMainAssetInvalidatedLow_SMT1 := false, ltfCompAssetInvalidatedLow_SMT1 := false
                    if enableAlerts_SMT1
                        alert("Potential Bullish SMT on SMT TF 1", alert.freq_once_per_bar)
    // =================================== END: CORRECTED SMT1 LTF LOGIC ===================================
    
    if not na(visualPivotA_HighLabel_SMT1)
        label.set_color(visualPivotA_HighLabel_SMT1, showPivotALabel_SMT1 ? color.new(phColor_SMT1, 25) : color.new(color.white, 100))
        label.set_textcolor(visualPivotA_HighLabel_SMT1, showPivotALabel_SMT1 ? color.white : color.new(color.white, 100))
    if not na(visualPivotA_LowLabel_SMT1)
        label.set_color(visualPivotA_LowLabel_SMT1, showPivotALabel_SMT1 ? color.new(plColor_SMT1, 25) : color.new(color.white, 100))
        label.set_textcolor(visualPivotA_LowLabel_SMT1, showPivotALabel_SMT1 ? color.white : color.new(color.white, 100))
else
    cleanupSmtDrawings1()
    pivotA_HighLabel_SMT1 := na, visualPivotA_HighLabel_SMT1 := na, pivotA_LowLabel_SMT1 := na, visualPivotA_LowLabel_SMT1 := na
    intraDayHighWatchline_SMT1 := na, intraDayHighLabel_SMT1 := na, intraDayLowWatchline_SMT1 := na, intraDayLowLabel_SMT1 := na


// =============================================================================
// SMT 2: LOGIC CHECKS
// =============================================================================
bool isHistoryCollectionActive_SMT2 = enableSMT2 and timeframeInput_SMT2 != ''
bool is_new_htf_bar_SMT2 = isHistoryCollectionActive_SMT2 and (nz(ta.change(time(timeframeInput_SMT2))) != 0)
bool isHtfChartTimeframeValid_SMT2 = timeframe.in_seconds(timeframe.period) <= timeframe.in_seconds(timeframeInput_SMT2)
bool isSmtLogicActive_SMT2 = isHtfChartTimeframeValid_SMT2 and isHistoryCollectionActive_SMT2 and enableSMT2 and masterComparisonAsset != ""

// =============================================================================
// SMT 2: HISTORY COLLECTION BLOCKS
// =============================================================================
var label[] smT2_PivotLabels = array.new_label()
var float smt2_session_high = high, var float smt2_session_low = low
var int smt2_session_high_time = time, var int smt2_session_low_time = time
var array<float> smt2_history_highs = array.new_float(), var array<float> smt2_history_lows = array.new_float()
var array<int> smt2_history_times_high = array.new_int(), var array<int> smt2_history_times_low = array.new_int()
var array<float> smt2_comp_history_highs = array.new_float(), var array<float> smt2_comp_history_lows = array.new_float()

if isHistoryCollectionActive_SMT2
    if is_new_htf_bar_SMT2
        smt2_session_high := high, smt2_session_low := low
        smt2_session_high_time := time, smt2_session_low_time := time
    else
        if high >= smt2_session_high
            smt2_session_high := high, smt2_session_high_time := time
        if low <= smt2_session_low
            smt2_session_low := low, smt2_session_low_time := time
    if is_new_htf_bar_SMT2
        array.push(smt2_history_highs, smt2_session_high[1]), array.push(smt2_history_times_high, smt2_session_high_time[1])
        array.push(smt2_history_lows, smt2_session_low[1]), array.push(smt2_history_times_low, smt2_session_low_time[1])
        float comp_high = request.security(masterComparisonAsset, timeframeInput_SMT2, high[1], lookahead=barmerge.lookahead_on)
        float comp_low = request.security(masterComparisonAsset, timeframeInput_SMT2, low[1], lookahead=barmerge.lookahead_on)
        array.push(smt2_comp_history_highs, comp_high), array.push(smt2_comp_history_lows, comp_low)

        if array.size(smt2_history_highs) > MAX_HISTORY_SIZE
            array.shift(smt2_history_highs)
            array.shift(smt2_history_times_high)
            array.shift(smt2_history_lows)
            array.shift(smt2_history_times_low)
            array.shift(smt2_comp_history_highs)
            array.shift(smt2_comp_history_lows)

        if showPivotCrosses_SMT2
            int pivot_check_index = array.size(smt2_history_highs) - 1 - rightBars_SMT2
            if pivot_check_index >= 0
                // MODIFICATION: Apply offset before drawing
                if checkForPivot(smt2_history_highs, pivot_check_index, leftBars_SMT2, rightBars_SMT2, true)
                    float pivot_price = array.get(smt2_history_highs, pivot_check_index)
                    float plot_price = pivot_price + priceOffset
                    drawPivotCross(smT2_PivotLabels, array.get(smt2_history_times_high, pivot_check_index), plot_price, phColor_SMT2)
                // MODIFICATION: Apply offset before drawing
                if checkForPivot(smt2_history_lows, pivot_check_index, leftBars_SMT2, rightBars_SMT2, false)
                    float pivot_price = array.get(smt2_history_lows, pivot_check_index)
                    float plot_price = pivot_price - priceOffset
                    drawPivotCross(smT2_PivotLabels, array.get(smt2_history_times_low, pivot_check_index), plot_price, plColor_SMT2)

// =============================================================================
// SMT 2: LOGIC
// =============================================================================
var label pivotA_HighLabel_SMT2 = na, var label visualPivotA_HighLabel_SMT2 = na, var label pivotA_LowLabel_SMT2 = na, var label visualPivotA_LowLabel_SMT2 = na, var line intraDayHighWatchline_SMT2 = na, var line intraDayLowWatchline_SMT2 = na, var label intraDayHighLabel_SMT2 = na, var label intraDayLowLabel_SMT2 = na, var float intraDayWatchlineHighPrice_SMT2 = na, var float intraDayWatchlineLowPrice_SMT2 = na, var bool ltfMainAssetInvalidatedHigh_SMT2 = false, var bool ltfCompAssetInvalidatedHigh_SMT2 = false, var bool ltfMainAssetInvalidatedLow_SMT2 = false, var bool ltfCompAssetInvalidatedLow_SMT2 = false
var array<line> smtConfirmedLines_SMT2 = array.new_line(), var array<label> smtConfirmedLabels_SMT2 = array.new_label()

cleanupSmtDrawings2() =>
    for l in smtConfirmedLines_SMT2
        line.delete(l)
    array.clear(smtConfirmedLines_SMT2)
    for l in smtConfirmedLabels_SMT2
        label.delete(l)
    array.clear(smtConfirmedLabels_SMT2)
    label.delete(pivotA_HighLabel_SMT2), label.delete(visualPivotA_HighLabel_SMT2)
    label.delete(pivotA_LowLabel_SMT2), label.delete(visualPivotA_LowLabel_SMT2)
    line.delete(intraDayHighWatchline_SMT2), label.delete(intraDayHighLabel_SMT2)
    line.delete(intraDayLowWatchline_SMT2), label.delete(intraDayLowLabel_SMT2)

if isSmtLogicActive_SMT2
    bool isWithinTimeSession = isWithinAnySession()
    string shortAssetName = getTicker(masterComparisonAsset)
    float atr_SMT2 = ta.atr(14) // This ATR is for the SMT labels, not the 'x' crosses
    float y_offset_SMT2 = atr_SMT2 * 0.1
    if is_new_htf_bar_SMT2
        int pivot_idx = array.size(smt2_history_highs) - 1 - rightBars_SMT2
        if pivot_idx >= 0
            bool is_main_pivot_high = checkForPivot(smt2_history_highs, pivot_idx, leftBars_SMT2, rightBars_SMT2, true)
            bool is_comp_pivot_high = checkForPivot(smt2_comp_history_highs, pivot_idx, leftBars_SMT2, rightBars_SMT2, true)
            if is_main_pivot_high and is_comp_pivot_high
                float mainHtfPivotHigh = array.get(smt2_history_highs, pivot_idx)
                float compHtfPivotHigh = array.get(smt2_comp_history_highs, pivot_idx)
                int smt_main_pivot_time = array.get(smt2_history_times_high, pivot_idx)
                if not na(pivotA_HighLabel_SMT2)
                    if (mainHtfPivotHigh - label.get_y(pivotA_HighLabel_SMT2)) * (compHtfPivotHigh - str.tonumber(label.get_text(pivotA_HighLabel_SMT2))) < 0
                        bool wasPivotARun = false
                        for i = pivot_idx - 1 to 0
                            if array.get(smt2_history_times_high, i) > label.get_x(pivotA_HighLabel_SMT2)
                                if array.get(smt2_history_highs, i) > label.get_y(pivotA_HighLabel_SMT2)
                                    wasPivotARun := true, break
                            else
                                break
                        if not wasPivotARun and isWithinTimeSession
                            string confirmedTextTemplate = "{0} vs {1}\nTimeframe: {2}\nStrength: {3}-{4}"
                            string baseInfoText = str.format(confirmedTextTemplate, syminfo.ticker, shortAssetName, formatTimeframe(timeframeInput_SMT2), str.tostring(leftBars_SMT2), str.tostring(rightBars_SMT2))
                            line newLine = line.new(label.get_x(pivotA_HighLabel_SMT2), label.get_y(pivotA_HighLabel_SMT2), smt_main_pivot_time, mainHtfPivotHigh, xloc = xloc.bar_time, color=color.new(phColor_SMT2, 40), width=2)
                            label newLabel = label.new(smt_main_pivot_time, mainHtfPivotHigh + y_offset_SMT2, "SMT Bearish\n" + baseInfoText + "\nStatus: Confirmed", xloc = xloc.bar_time, color=color.new(phColor_SMT2, 75), textcolor=color.white, style=label.style_label_down, size=size.normal, textalign=text.align_left)
                            array.push(smtConfirmedLines_SMT2, newLine), array.push(smtConfirmedLabels_SMT2, newLabel)
                            if enableAlerts_SMT2
                                alert("Confirmed Bearish SMT on SMT TF2", alert.freq_once_per_bar)
                line.delete(intraDayHighWatchline_SMT2), intraDayHighWatchline_SMT2 := na, label.delete(intraDayHighLabel_SMT2), intraDayHighLabel_SMT2 := na, intraDayWatchlineHighPrice_SMT2 := na
                label.delete(pivotA_HighLabel_SMT2), label.delete(visualPivotA_HighLabel_SMT2)
                pivotA_HighLabel_SMT2 := label.new(smt_main_pivot_time, mainHtfPivotHigh, str.tostring(compHtfPivotHigh), xloc = xloc.bar_time, style=label.style_none, textcolor=color.new(color.white, 100))
                visualPivotA_HighLabel_SMT2 := label.new(smt_main_pivot_time, mainHtfPivotHigh + y_offset_SMT2, "A", xloc=xloc.bar_time, style=label.style_label_down, color=color.new(phColor_SMT2, 25), textcolor=color.white, size=size.small, tooltip="Pivot A High")
                ltfMainAssetInvalidatedHigh_SMT2 := false, ltfCompAssetInvalidatedHigh_SMT2 := false
            bool is_main_pivot_low = checkForPivot(smt2_history_lows, pivot_idx, leftBars_SMT2, rightBars_SMT2, false)
            bool is_comp_pivot_low = checkForPivot(smt2_comp_history_lows, pivot_idx, leftBars_SMT2, rightBars_SMT2, false)
            if is_main_pivot_low and is_comp_pivot_low
                float mainHtfPivotLow = array.get(smt2_history_lows, pivot_idx)
                float compHtfPivotLow = array.get(smt2_comp_history_lows, pivot_idx)
                int smt_main_pivot_time = array.get(smt2_history_times_low, pivot_idx)
                if not na(pivotA_LowLabel_SMT2)
                    if (mainHtfPivotLow - label.get_y(pivotA_LowLabel_SMT2)) * (compHtfPivotLow - str.tonumber(label.get_text(pivotA_LowLabel_SMT2))) < 0
                        bool wasPivotARun = false
                        for i = pivot_idx - 1 to 0
                            if array.get(smt2_history_times_low, i) > label.get_x(pivotA_LowLabel_SMT2)
                                if array.get(smt2_history_lows, i) < label.get_y(pivotA_LowLabel_SMT2)
                                    wasPivotARun := true, break
                            else
                                break
                        if not wasPivotARun and isWithinTimeSession
                            string confirmedTextTemplate = "{0} vs {1}\nTimeframe: {2}\nStrength: {3}-{4}"
                            string baseInfoText = str.format(confirmedTextTemplate, syminfo.ticker, shortAssetName, formatTimeframe(timeframeInput_SMT2), str.tostring(leftBars_SMT2), str.tostring(rightBars_SMT2))
                            line newLine = line.new(label.get_x(pivotA_LowLabel_SMT2), label.get_y(pivotA_LowLabel_SMT2), smt_main_pivot_time, mainHtfPivotLow, xloc = xloc.bar_time, color=color.new(plColor_SMT2, 40), width=2)
                            label newLabel = label.new(smt_main_pivot_time, mainHtfPivotLow - y_offset_SMT2, "SMT Bullish\n" + baseInfoText + "\nStatus: Confirmed", xloc = xloc.bar_time, color=color.new(plColor_SMT2, 75), textcolor=color.white, style=label.style_label_up, size=size.normal, textalign=text.align_left)
                            array.push(smtConfirmedLines_SMT2, newLine), array.push(smtConfirmedLabels_SMT2, newLabel)
                            if enableAlerts_SMT2
                                alert("Confirmed Bullish SMT on SMT TF2", alert.freq_once_per_bar)
                line.delete(intraDayLowWatchline_SMT2), intraDayLowWatchline_SMT2 := na, label.delete(intraDayLowLabel_SMT2), intraDayLowLabel_SMT2 := na, intraDayWatchlineLowPrice_SMT2 := na
                label.delete(pivotA_LowLabel_SMT2), label.delete(visualPivotA_LowLabel_SMT2)
                pivotA_LowLabel_SMT2 := label.new(smt_main_pivot_time, mainHtfPivotLow, str.tostring(compHtfPivotLow), xloc = xloc.bar_time, style=label.style_none, textcolor=color.new(color.white, 100))
                visualPivotA_LowLabel_SMT2 := label.new(smt_main_pivot_time, mainHtfPivotLow - y_offset_SMT2, "A", xloc=xloc.bar_time, style=label.style_label_up, color=color.new(plColor_SMT2, 25), textcolor=color.white, size=size.small, tooltip="Pivot A Low")
                ltfMainAssetInvalidatedLow_SMT2 := false, ltfCompAssetInvalidatedLow_SMT2 := false
    
    // =================================== START: CORRECTED SMT2 LTF LOGIC ===================================
    if enableEarlySmtDetection_SMT2 and intradayTimeframe_SMT2 != '' and timeframe.in_seconds(timeframe.period) <= timeframe.in_seconds(intradayTimeframe_SMT2)
        bool is_new_intraday_bar = ta.change(time(intradayTimeframe_SMT2)) != 0
        var float intraday_session_high_SMT2 = high, var float intraday_session_low_SMT2 = low, var int intraday_session_high_time_SMT2 = time, var int intraday_session_low_time_SMT2 = time
        
        // --- Reverted Per-Bar Fallback System (More Robust) ---
        var string usedLtfTimeframe_SMT2 = intradayTimeframe_SMT2
        [intra_comp_high_realtime_SMT2_base, intra_comp_low_realtime_SMT2_base] = request.security(masterComparisonAsset, intradayTimeframe_SMT2, [high, low], lookahead=barmerge.lookahead_off)
        usedLtfTimeframe_SMT2 := intradayTimeframe_SMT2
        
        float intra_comp_high_realtime_SMT2 = intra_comp_high_realtime_SMT2_base
        float intra_comp_low_realtime_SMT2 = intra_comp_low_realtime_SMT2_base

        if na(intra_comp_high_realtime_SMT2)
            [intra_comp_high_realtime_SMT2, intra_comp_low_realtime_SMT2] = request.security(masterComparisonAsset, '15', [high, low], lookahead=barmerge.lookahead_off)
            usedLtfTimeframe_SMT2 := '15'
        if na(intra_comp_high_realtime_SMT2)
            [intra_comp_high_realtime_SMT2, intra_comp_low_realtime_SMT2] = request.security(masterComparisonAsset, '60', [high, low], lookahead=barmerge.lookahead_off)
            usedLtfTimeframe_SMT2 := '60'

        var float intraday_comp_session_high_SMT2 = intra_comp_high_realtime_SMT2, var float intraday_comp_session_low_SMT2 = intra_comp_low_realtime_SMT2
        if is_new_intraday_bar
            intraday_session_high_SMT2 := high, intraday_session_low_SMT2 := low, intraday_session_high_time_SMT2 := time, intraday_session_low_time_SMT2 := time
            intraday_comp_session_high_SMT2 := intra_comp_high_realtime_SMT2, intraday_comp_session_low_SMT2 := intra_comp_low_realtime_SMT2
        else
            if high > intraday_session_high_SMT2
                intraday_session_high_SMT2 := high, intraday_session_high_time_SMT2 := time
            if low < intraday_session_low_SMT2
                intraday_session_low_SMT2 := low, intraday_session_low_time_SMT2 := time
            if intra_comp_high_realtime_SMT2 > intraday_comp_session_high_SMT2
                intraday_comp_session_high_SMT2 := intra_comp_high_realtime_SMT2
            if intra_comp_low_realtime_SMT2 < intraday_comp_session_low_SMT2
                intraday_comp_session_low_SMT2 := intra_comp_low_realtime_SMT2
        if is_new_intraday_bar
            float ltf_main_high = intraday_session_high_SMT2[1], float ltf_main_low = intraday_session_low_SMT2[1]
            float intra_comp_high = intraday_comp_session_high_SMT2[1], float intra_comp_low = intraday_comp_session_low_SMT2[1]
            if not na(pivotA_HighLabel_SMT2)
                if not ltfMainAssetInvalidatedHigh_SMT2 and ltf_main_high > label.get_y(pivotA_HighLabel_SMT2)
                    ltfMainAssetInvalidatedHigh_SMT2 := true
                if not ltfCompAssetInvalidatedHigh_SMT2 and intra_comp_high > str.tonumber(label.get_text(pivotA_HighLabel_SMT2))
                    ltfCompAssetInvalidatedHigh_SMT2 := true
                if ltfMainAssetInvalidatedHigh_SMT2 and ltfCompAssetInvalidatedHigh_SMT2
                    label.delete(pivotA_HighLabel_SMT2), pivotA_HighLabel_SMT2 := na, label.delete(visualPivotA_HighLabel_SMT2), visualPivotA_HighLabel_SMT2 := na
                    line.delete(intraDayHighWatchline_SMT2), intraDayHighWatchline_SMT2 := na, label.delete(intraDayHighLabel_SMT2), intraDayHighLabel_SMT2 := na
            if not na(pivotA_LowLabel_SMT2)
                if not ltfMainAssetInvalidatedLow_SMT2 and ltf_main_low < label.get_y(pivotA_LowLabel_SMT2)
                    ltfMainAssetInvalidatedLow_SMT2 := true
                if not ltfCompAssetInvalidatedLow_SMT2 and intra_comp_low < str.tonumber(label.get_text(pivotA_LowLabel_SMT2))
                    ltfCompAssetInvalidatedLow_SMT2 := true
                if ltfMainAssetInvalidatedLow_SMT2 and ltfCompAssetInvalidatedLow_SMT2
                    label.delete(pivotA_LowLabel_SMT2), pivotA_LowLabel_SMT2 := na, label.delete(visualPivotA_LowLabel_SMT2), visualPivotA_LowLabel_SMT2 := na
                    line.delete(intraDayLowWatchline_SMT2), intraDayLowWatchline_SMT2 := na, label.delete(intraDayLowLabel_SMT2), intraDayLowLabel_SMT2 := na
            int ltf_main_high_time = intraday_session_high_time_SMT2[1], int ltf_main_low_time = intraday_session_low_time_SMT2[1]
            if not na(pivotA_HighLabel_SMT2)
                bool alreadyInvalidated = ltfMainAssetInvalidatedHigh_SMT2 and ltfCompAssetInvalidatedHigh_SMT2
                if not alreadyInvalidated and (ltf_main_high - label.get_y(pivotA_HighLabel_SMT2)) * (intra_comp_high - str.tonumber(label.get_text(pivotA_HighLabel_SMT2))) < 0 and (na(intraDayWatchlineHighPrice_SMT2) or ltf_main_high > intraDayWatchlineHighPrice_SMT2) and isWithinTimeSession
                    string ltfBaseTextTemplate = "{0} vs {1}\nTimeframe: {2}\nStrength: {3}-{4}\nLTF Detection: {5}"
                    string ltfBaseInfoText = str.format(ltfBaseTextTemplate, syminfo.ticker, shortAssetName, formatTimeframe(timeframeInput_SMT2), str.tostring(leftBars_SMT2), str.tostring(rightBars_SMT2), formatTimeframe(usedLtfTimeframe_SMT2))
                    line.delete(intraDayHighWatchline_SMT2), label.delete(intraDayHighLabel_SMT2)
                    intraDayHighWatchline_SMT2 := line.new(label.get_x(pivotA_HighLabel_SMT2), label.get_y(pivotA_HighLabel_SMT2), ltf_main_high_time, ltf_main_high, xloc = xloc.bar_time, style=line.style_dashed, color=phColor_SMT2, width=1)
                    intraDayHighLabel_SMT2 := label.new(ltf_main_high_time, ltf_main_high + y_offset_SMT2, "SMT Bearish\n" + ltfBaseInfoText + "\nStatus: Unconfirmed", xloc = xloc.bar_time, color=color.new(phColor_SMT2, 75), textcolor=color.white, style=label.style_label_down, textalign=text.align_left)
                    intraDayWatchlineHighPrice_SMT2 := ltf_main_high, ltfMainAssetInvalidatedHigh_SMT2 := false, ltfCompAssetInvalidatedHigh_SMT2 := false
                    if enableAlerts_SMT2
                        alert("Potential Bearish SMT on SMT TF 2", alert.freq_once_per_bar)
            if not na(pivotA_LowLabel_SMT2)
                bool alreadyInvalidated = ltfMainAssetInvalidatedLow_SMT2 and ltfCompAssetInvalidatedLow_SMT2
                if not alreadyInvalidated and (ltf_main_low - label.get_y(pivotA_LowLabel_SMT2)) * (intra_comp_low - str.tonumber(label.get_text(pivotA_LowLabel_SMT2))) < 0 and (na(intraDayWatchlineLowPrice_SMT2) or ltf_main_low < intraDayWatchlineLowPrice_SMT2) and isWithinTimeSession
                    string ltfBaseTextTemplate = "{0} vs {1}\nTimeframe: {2}\nStrength: {3}-{4}\nLTF Detection: {5}"
                    string ltfBaseInfoText = str.format(ltfBaseTextTemplate, syminfo.ticker, shortAssetName, formatTimeframe(timeframeInput_SMT2), str.tostring(leftBars_SMT2), str.tostring(rightBars_SMT2), formatTimeframe(usedLtfTimeframe_SMT2))
                    line.delete(intraDayLowWatchline_SMT2), label.delete(intraDayLowLabel_SMT2)
                    intraDayLowWatchline_SMT2 := line.new(label.get_x(pivotA_LowLabel_SMT2), label.get_y(pivotA_LowLabel_SMT2), ltf_main_low_time, ltf_main_low, xloc = xloc.bar_time, style=line.style_dashed, color=plColor_SMT2, width=1)
                    intraDayLowLabel_SMT2 := label.new(ltf_main_low_time, ltf_main_low - y_offset_SMT2, "SMT Bullish\n" + ltfBaseInfoText + "\nStatus: Unconfirmed", xloc = xloc.bar_time, color=color.new(plColor_SMT2, 75), textcolor=color.white, style=label.style_label_up, textalign=text.align_left)
                    intraDayWatchlineLowPrice_SMT2 := ltf_main_low, ltfMainAssetInvalidatedLow_SMT2 := false, ltfCompAssetInvalidatedLow_SMT2 := false
                    if enableAlerts_SMT2
                        alert("Potential Bullish SMT on SMT TF 2", alert.freq_once_per_bar)
    // =================================== END: CORRECTED SMT2 LTF LOGIC ===================================
        
    if not na(visualPivotA_HighLabel_SMT2)
        label.set_color(visualPivotA_HighLabel_SMT2, showPivotALabel_SMT2 ? color.new(phColor_SMT2, 25) : color.new(color.white, 100))
        label.set_textcolor(visualPivotA_HighLabel_SMT2, showPivotALabel_SMT2 ? color.white : color.new(color.white, 100))
    if not na(visualPivotA_LowLabel_SMT2)
        label.set_color(visualPivotA_LowLabel_SMT2, showPivotALabel_SMT2 ? color.new(plColor_SMT2, 25) : color.new(color.white, 100))
        label.set_textcolor(visualPivotA_LowLabel_SMT2, showPivotALabel_SMT2 ? color.white : color.new(color.white, 100))
else
    cleanupSmtDrawings2()
    pivotA_HighLabel_SMT2 := na, visualPivotA_HighLabel_SMT2 := na, pivotA_LowLabel_SMT2 := na, visualPivotA_LowLabel_SMT2 := na
    intraDayHighWatchline_SMT2 := na, intraDayHighLabel_SMT2 := na, intraDayLowWatchline_SMT2 := na, intraDayLowLabel_SMT2 := na
